#!/usr/bin/env node
import*as w from"path";import*as p from"fs";import l from"chalk";var f=class extends Error{constructor(t){super(t),this.name="BuildError"}},g=l.cyan("kumoya"),s={info:i=>{console.log(`${g} ${i}`)},error:i=>{i instanceof Error?(console.error(`${g} ${l.red("\u2716")} Build Error:`),console.error(`    ${i.message}`),i.stack&&console.error(l.gray(i.stack.split(`
    `).slice(1).map(t=>`    ${t.trim()}`).join(`
    `)))):(console.error(`${g} ${l.red("\u2716")} Build Error:`),console.error(`    ${i}`))},success:i=>{console.log(`${g} ${l.green("\u2713")} Done!`)},warn:i=>{console.log(`${g} ${l.yellow("\u26A0")} ${i}`)}};import{pathToFileURL as j}from"url";var $=`export const kumoyaConfig = {
      entry: './src/index.ts',
      outputFolder: 'dist',
      bundle: true,
      outputType: true,
      minify: true,
      platform: 'node',
      packages: 'external',
    };
    `,k=new Set(["entry","outputFolder","outfile","bundle","outputType","format","platform","minify","packages","external","target","sourcemap","treeShaking","logLevel","extension"]);function v(i){let t={};t.platform="node",t.format="cjs";for(let o in i)k.has(o)?t[o]=i[o]:s.warn(`Unknown kumoya config option: "${o}", this option will be ignored`);return(Array.isArray(i.entry)?i.entry:[i.entry]).some(o=>o.endsWith(".js"))&&!i.platform&&!i.format&&s.warn("Building .js files without specified 'platform' or 'format'. Using default: platform='node', format='cjs'"),t}async function h(i="kumoya.config.mjs"){let t=w.resolve(process.cwd(),i);if(!p.existsSync(t)){s.info("Config file not found, creating default configuration...");try{p.writeFileSync(t,$,"utf-8"),s.success(`Default config file created: ${i}`),process.exit(0)}catch(e){throw new f(`Failed to create config file: ${e.message}`)}}try{let n=await import(j(t).href);if(!n.kumoyaConfig)throw new f("kumoyaConfig is required in config file");if(!n.kumoyaConfig.entry)throw new f("entry is required in kumoyaConfig");return{kumoyaConfig:v(n.kumoyaConfig),esbuildConfig:n.esbuildConfig,rollupConfig:n.rollupConfig}}catch(e){throw e instanceof f?e:new f(`Failed to load config file: ${e.message}`)}}import*as b from"esbuild";import{rollup as D}from"rollup";import F from"rollup-plugin-dts";import O from"@rollup/plugin-multi-entry";import{exec as E}from"child_process";import{promisify as S}from"util";import*as r from"path";import*as c from"fs";import{minimatch as C}from"minimatch";var d=S(E),u=class{config;esbuildConfig;rollupConfig;tsConfig;constructor(t){if(this.config={platform:"node",format:"cjs",...t.kumoyaConfig},this.config.format==="both"&&this.config.extension&&this.config.extension!=="js")throw new f("Cannot specify custom extension when format is 'both'");if(this.config.extension&&!["js","cjs","mjs"].includes(this.config.extension))throw new f("Extension must be one of: js, cjs, mjs");if(this.config.outputFolder&&this.config.outfile)throw new Error("outputFolder and outfile cannot be used together");if(this.config.outfile&&!this.config.bundle)throw new Error("outfile requires bundle to be true");try{let e=r.join(process.cwd(),"tsconfig.json");if(this.tsConfig=JSON.parse(c.readFileSync(e,"utf-8")),this.config.target)typeof this.config.target=="string"&&(this.config.target=this.config.target.toLowerCase());else{let n=this.tsConfig?.compilerOptions?.target?.toLowerCase();n&&(this.config.target=n,s.info(`Using target from tsconfig.json: ${this.config.target}`))}}catch{s.warn("Failed to read tsconfig.json, using default target settings"),this.tsConfig={}}!this.config.outputFolder&&!this.config.outfile&&(this.config.outputFolder=this.tsConfig?.compilerOptions?.outDir||"dist"),this.esbuildConfig=t.esbuildConfig,this.rollupConfig=t.rollupConfig}getOutputExtension(t){return this.config.format==="both"?t==="esm"?".mjs":".cjs":this.config.extension?`.${this.config.extension}`:".js"}async buildWithEsbuild(t,e="cjs"){let n;if(this.config.outfile)n=this.config.outfile,e=r.extname(this.config.outfile)==="mjs"?"esm":"cjs";else{let a=this.getOutputExtension(e);n=r.join(this.config.outputFolder,`${r.parse(t).name}${a}`)}if(this.config.packages&&this.config.external)throw new f("Cannot use both 'packages' and 'external' options");let o={entryPoints:[t],bundle:this.config.bundle,outfile:n,packages:this.config.packages||"external",platform:this.config.platform||"node",format:e,target:this.config.target||"es2015"};this.config.minify!==void 0&&(o.minify=this.config.minify),this.config.sourcemap!==void 0&&(o.sourcemap=this.config.sourcemap),this.config.treeShaking!==void 0&&(o.treeShaking=this.config.treeShaking),this.config.logLevel&&(o.logLevel=this.config.logLevel),this.config.external?.length&&(o.external=this.config.external),s.info(`${t} ==> ${n}`),await b.build({...o,...this.esbuildConfig})}getEntryDirs(){return(Array.isArray(this.config.entry)?this.config.entry:[this.config.entry]).reduce((e,n)=>{let o=r.dirname(n);return e[o]=e[o]||[],e[o].push(n),e},{})}isInTsConfig(t){let e=this.tsConfig?.include||[],n=this.tsConfig?.exclude||[];return e.some(o=>C(t,o))&&!n.some(o=>C(t,o))}async buildTypes(){let t=r.join(process.cwd(),".kumoyatmp"),e=this.getEntryDirs(),n=Object.keys(e);try{if(this.config.bundle){if(n.length===1&&(this.isInTsConfig(n[0])||this.tsConfig?.compilerOptions?.rootDir)){let a=this.tsConfig?.compilerOptions?.rootDir||n[0];await d(`tsc --declaration --emitDeclarationOnly --rootDir ${a} --outDir ${t}`)}else for(let a of n){let m=r.join(t,r.basename(a));await d(`tsc --declaration --emitDeclarationOnly --rootDir ${a} --outDir ${m} ${e[a].join(" ")}`)}let o=Array.isArray(this.config.entry)?this.config.entry:[this.config.entry];for(let a of o){let m=r.parse(a).name,x=this.config.outfile?r.dirname(this.config.outfile):this.config.outputFolder,y=r.join(x,`${m}.d.ts`);s.info(`${a} ==> ${y}`),await(await D({input:`${t}/**/*.d.ts`,plugins:[O(),F(),...this.rollupConfig?.plugins||[]]})).write({file:y,format:"es"})}c.existsSync(t)&&c.rmSync(t,{recursive:!0,force:!0})}else await d(`tsc --declaration --emitDeclarationOnly --outDir ${this.config.outputFolder}`)}catch(o){throw c.existsSync(t)&&c.rmSync(t,{recursive:!0,force:!0}),o}}async build(){let t=Array.isArray(this.config.entry)?this.config.entry:[this.config.entry],e=this.config.format==="both"?["esm","cjs"]:[this.config.format||"cjs"];for(let n of t)for(let o of e)await this.buildWithEsbuild(n,o);this.config.outputType&&await this.buildTypes()}};async function B(){try{let i=await h();s.info("Starting build process..."),await new u(i).build(),s.success("Done!")}catch(i){i instanceof f?s.error(i):s.error(i),process.exit(1)}}B();export{u as Builder,h as loadConfig};
    